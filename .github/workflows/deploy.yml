name: Deploy to DigitalOcean

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Deploy
        run: |
          # Create deployment script
          cat > deploy.sh << 'SCRIPT'
          set -e
          echo "Starting deployment..."
          
          cd /root
          if [ ! -d "app" ]; then
            git clone $GITHUB_REPO app
          fi
          cd app
          
          git fetch origin main
          git reset --hard origin/main
          
          # Fix .env for localhost
          if [ ! -f .env ]; then
            cat > .env << 'ENV'
            EMAIL_FROM="BrandedUK <info@brandeduk.com>"
            EMAIL_TO=info@brandeduk.com
            NODE_ENV=production
            QUOTE_EMAIL_DEV=info@brandeduk.com
            RESEND_API_KEY=re_5NxbK1kB_5BFDWnjGszj5BF51Mj7qXo1r
            SMTP_HOST=smtp.gmail.com
            SMTP_PASS=wpowirmmtibzucow
            SMTP_PORT=587
            SMTP_USER=faizanarshaddev@gmail.com
            DB_POOL_MAX=50
            DB_POOL_MIN=5
            DB_SSL=false
            DB_HOST=localhost
            DB_NAME=brandeduk_prod
            DB_PASSWORD=omglol123
          DB_PORT=5432
          DB_USER=brandeduk
          ENV
          else
            sed -i 's/DB_HOST=.*/DB_HOST=localhost/' .env
            sed -i 's/DB_SSL=true/DB_SSL=false/' .env 2>/dev/null || true
          fi
          
          # Fix JS files
          find . -name "*.js" -type f -exec sed -i 's/206\.189\.119\.150/localhost/g' {} \;
          
          npm install --production
          
          if pm2 list | grep -q "branded-api"; then
            pm2 restart branded-api
          else
            pm2 start server.js --name "branded-api"
            pm2 save
          fi
          
          sleep 3
          curl -f http://localhost:3004/health && echo "Deployment successful!" || echo "Health check failed"
          SCRIPT
          
          # Copy and run
          scp -o StrictHostKeyChecking=no deploy.sh root@${{ secrets.SERVER_IP }}:/tmp/
          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "bash /tmp/deploy.sh && rm /tmp/deploy.sh"